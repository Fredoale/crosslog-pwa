## ğŸ¤– NUEVO: ASISTENTE WHATSAPP PARA CONSULTAS

### Objetivo
Crear un flujo N8N que permita:
- Consultar estado de HDR por WhatsApp
- Solicitar resumen de entregas
- Pedir remitos especÃ­ficos
- Disponible para clientes y coordinador

### Arquitectura del Flujo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FLUJO ASISTENTE WHATSAPP                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
1. Webhook WhatsApp Business API
   â†“
   Recibe mensaje entrante

2. Detectar IntenciÃ³n (Code Node)
   â†“
   Parsear mensaje y detectar:
   - Consulta de estado: "estado 7366289" o "7366289"
   - Resumen: "resumen 7366289"
   - Remito: "remito 38269"

3. Switch (Router)
   â†“
   â”œâ”€ Consulta Estado â†’ Nodo 4
   â”œâ”€ Resumen â†’ Nodo 5
   â””â”€ Remito â†’ Nodo 6

4. Consulta Estado (Google Sheets Lookup + Code)
   â†“
   - Buscar HDR en Sistema_entregas
   - Obtener entregas completadas/pendientes
   - Generar mensaje de estado

5. Resumen Completo (Google Sheets Lookup + Code)
   â†“
   - Buscar todas las entregas del HDR
   - Generar mensaje con lista de entregas
   - Incluir links a PDFs

6. Remito EspecÃ­fico (Google Sheets Lookup + Code)
   â†“
   - Buscar nÃºmero de remito
   - Obtener HDR asociado
   - Responder con link al PDF

7. HTTP Request â†’ WhatsApp API
   â†“
   Enviar respuesta al usuario
```

### ImplementaciÃ³n Detallada

#### Nodo 1: Webhook WhatsApp
**ConfiguraciÃ³n**:
- URL: `/webhook/whatsapp-consultas`
- Method: POST
- Recibe mensajes desde WhatsApp Business API

**Estructura mensaje entrante**:
```json
{
  "messaging_product": "whatsapp",
  "from": "5491154096639",
  "message": {
    "type": "text",
    "text": {
      "body": "estado 7366289"
    }
  }
}
```

#### Nodo 2: Detectar IntenciÃ³n (Code)
```javascript
const mensaje = $input.first().json.message.text.body.toLowerCase().trim();
const from = $input.first().json.from;

console.log('[Asistente] Mensaje recibido:', mensaje, 'de:', from);

// Patrones de intenciÃ³n
let intencion = 'desconocido';
let parametro = '';

// Detectar HDR (nÃºmeros de 7 dÃ­gitos)
const hdrMatch = mensaje.match(/\b\d{7}\b/);
const hdr = hdrMatch ? hdrMatch[0] : '';

// Detectar remito (nÃºmeros de 5 dÃ­gitos)
const remitoMatch = mensaje.match(/\b\d{5}\b/);
const remito = remitoMatch ? remitoMatch[0] : '';

if (mensaje.includes('estado') && hdr) {
  intencion = 'consulta_estado';
  parametro = hdr;
} else if (mensaje.includes('resumen') && hdr) {
  intencion = 'resumen';
  parametro = hdr;
} else if (mensaje.includes('remito') && remito) {
  intencion = 'buscar_remito';
  parametro = remito;
} else if (hdr && !mensaje.includes('remito')) {
  // Solo nÃºmero de HDR = consulta estado por defecto
  intencion = 'consulta_estado';
  parametro = hdr;
} else if (remito) {
  // Solo nÃºmero de remito
  intencion = 'buscar_remito';
  parametro = remito;
} else {
  intencion = 'ayuda';
}

return {
  json: {
    intencion: intencion,
    parametro: parametro,
    from: from,
    mensajeOriginal: mensaje
  }
};
```

#### Nodo 3: Switch (Router)
**ConfiguraciÃ³n**:
- Output 1: `{{ $json.intencion }}` equals `consulta_estado`
- Output 2: `{{ $json.intencion }}` equals `resumen`
- Output 3: `{{ $json.intencion }}` equals `buscar_remito`
- Output 4: `{{ $json.intencion }}` equals `ayuda`

#### Nodo 4: Consulta Estado (Google Sheets Lookup + Code)

**Google Sheets Lookup**:
- Sheet: `Sistema_entregas`
- Lookup Column: B (Numero_HDR)
- Lookup Value: `{{ $json.parametro }}`
- Return All Matches: YES

**Code Node**:
```javascript
const entregas = $input.all().map(item => item.json);
const hdr = $('Nodo 2').first().json.parametro;
const from = $('Nodo 2').first().json.from;

if (entregas.length === 0) {
  return {
    json: {
      to: from,
      mensaje: `âŒ No encontrÃ© entregas para el HDR ${hdr}\n\nVerifica el nÃºmero e intenta nuevamente.`
    }
  };
}

const totalEntregas = entregas.length;
const completadas = entregas.filter(e => e.Estado === 'COMPLETADO').length;
const pendientes = totalEntregas - completadas;
const progreso = Math.round((completadas / totalEntregas) * 100);

const chofer = entregas[0].Chofer || 'N/A';
const fechaViaje = entregas[0].fecha_viaje || 'N/A';

let mensaje = `ğŸ“¦ *HDR ${hdr}*\n\n`;
mensaje += `ğŸ‘¤ Chofer: ${chofer}\n`;
mensaje += `ğŸ“… Fecha: ${fechaViaje}\n\n`;
mensaje += `ğŸ“Š *Estado:*\n`;
mensaje += `âœ… Completadas: ${completadas}/${totalEntregas}\n`;
mensaje += `â³ Pendientes: ${pendientes}\n`;
mensaje += `ğŸ“ˆ Progreso: ${progreso}%\n\n`;

if (completadas === totalEntregas) {
  mensaje += `ğŸ‰ *Â¡Todas las entregas completadas!*`;
} else {
  mensaje += `ğŸšš Entregas en progreso...`;
}

return {
  json: {
    to: from,
    mensaje: mensaje
  }
};
```

#### Nodo 5: Resumen Completo (Code)
```javascript
const entregas = $input.all().map(item => item.json);
const hdr = $('Nodo 2').first().json.parametro;
const from = $('Nodo 2').first().json.from;

if (entregas.length === 0) {
  return {
    json: {
      to: from,
      mensaje: `âŒ No encontrÃ© entregas para el HDR ${hdr}`
    }
  };
}

const chofer = entregas[0].Chofer;
const fechaViaje = entregas[0].fecha_viaje;

let mensaje = `ğŸ“‹ *RESUMEN HDR ${hdr}*\n\n`;
mensaje += `ğŸ‘¤ ${chofer} | ğŸ“… ${fechaViaje}\n\n`;

entregas.forEach((entrega, idx) => {
  const numero = entrega.numero_entrega || (idx + 1);
  const destino = entrega.Detalle_entrega || 'N/A';

  // Parsear destino si es array
  let destinoFinal = destino;
  if (destino.startsWith('[')) {
    try {
      const parsed = JSON.parse(destino);
      destinoFinal = parsed[numero - 1] || parsed[0];
    } catch (e) {}
  }

  const estado = entrega.Estado === 'COMPLETADO' ? 'âœ…' : 'â³';
  const remitos = JSON.parse(entrega.numero_remitos || '[]');

  mensaje += `${estado} *Entrega ${numero}*\n`;
  mensaje += `ğŸ“ ${destinoFinal}\n`;
  mensaje += `ğŸ“„ Remito: ${remitos.join(', ')}\n`;

  // Link a PDF si estÃ¡ completado
  if (entrega.Estado === 'COMPLETADO') {
    try {
      const pdfs = JSON.parse(entrega.pdf_urls || '[]');
      if (pdfs.length > 0) {
        mensaje += `ğŸ”— ${pdfs[0]}\n`;
      }
    } catch (e) {}
  }

  mensaje += `\n`;
});

return {
  json: {
    to: from,
    mensaje: mensaje
  }
};
```

#### Nodo 6: Buscar Remito (Google Sheets Search + Code)

**Google Sheets Search**:
- Sheet: `Sistema_entregas`
- Columns to Search: D (numero_remitos)
- Search Value: `{{ $json.parametro }}`

**Code Node**:
```javascript
const resultados = $input.all().map(item => item.json);
const remito = $('Nodo 2').first().json.parametro;
const from = $('Nodo 2').first().json.from;

if (resultados.length === 0) {
  return {
    json: {
      to: from,
      mensaje: `âŒ No encontrÃ© el remito ${remito}\n\nVerifica el nÃºmero e intenta nuevamente.`
    }
  };
}

const entrega = resultados[0];
const hdr = entrega.Numero_HDR;
const destino = entrega.Detalle_entrega;
const estado = entrega.Estado;

let mensaje = `ğŸ“„ *Remito ${remito}*\n\n`;
mensaje += `ğŸ“¦ HDR: ${hdr}\n`;
mensaje += `ğŸ“ Destino: ${destino}\n`;
mensaje += `${estado === 'COMPLETADO' ? 'âœ… Completado' : 'â³ Pendiente'}\n\n`;

if (estado === 'COMPLETADO') {
  try {
    const pdfs = JSON.parse(entrega.pdf_urls || '[]');
    if (pdfs.length > 0) {
      mensaje += `ğŸ“ Ver PDF:\n${pdfs[0]}`;
    }
  } catch (e) {
    mensaje += `âš ï¸ PDF no disponible`;
  }
} else {
  mensaje += `â³ Entrega aÃºn no completada`;
}

return {
  json: {
    to: from,
    mensaje: mensaje
  }
};
```

#### Nodo 7: Mensaje de Ayuda (Code)
```javascript
const from = $input.first().json.from;

const mensaje = `ğŸ¤– *Asistente CROSSLOG*\n\n` +
  `Puedo ayudarte con:\n\n` +
  `ğŸ“¦ *Estado de HDR*\n` +
  `EnvÃ­a: "estado 7366289" o solo "7366289"\n\n` +
  `ğŸ“‹ *Resumen completo*\n` +
  `EnvÃ­a: "resumen 7366289"\n\n` +
  `ğŸ“„ *Buscar remito*\n` +
  `EnvÃ­a: "remito 38269" o solo "38269"\n\n` +
  `ğŸ’¡ Ejemplos:\n` +
  `â€¢ "7366289" â†’ Estado del HDR\n` +
  `â€¢ "resumen 7366289" â†’ Lista de entregas\n` +
  `â€¢ "38269" â†’ InformaciÃ³n del remito`;

return {
  json: {
    to: from,
    mensaje: mensaje
  }
};
```

#### Nodo 8: Enviar Respuesta WhatsApp (HTTP Request)

**ConfiguraciÃ³n**:
- Method: POST
- URL: `https://graph.facebook.com/v22.0/764420436762718/messages`
- Authentication: Header Auth
  - Name: `Authorization`
  - Value: `Bearer YOUR_TOKEN`
- Body Content Type: JSON
- Body:
```json
{
  "messaging_product": "whatsapp",
  "to": "{{ $json.to }}",
  "type": "text",
  "text": {
    "body": "{{ $json.mensaje }}"
  }
}
```

### Testing del Asistente

**Test 1 - Consulta Estado**:
Enviar por WhatsApp: `estado 7366289`
Respuesta esperada:
```
ğŸ“¦ HDR 7366289

ğŸ‘¤ Chofer: Martin Romero
ğŸ“… Fecha: 25-09-2025

ğŸ“Š Estado:
âœ… Completadas: 2/2
â³ Pendientes: 0
ğŸ“ˆ Progreso: 100%

ğŸ‰ Â¡Todas las entregas completadas!
```

**Test 2 - Resumen**:
Enviar: `resumen 7366289`
Respuesta esperada:
```
ğŸ“‹ RESUMEN HDR 7366289

ğŸ‘¤ Martin Romero | ğŸ“… 25-09-2025

âœ… Entrega 1
ğŸ“ SCC POWER - SAN PEDRO
ğŸ“„ Remito: 38269
ğŸ”— https://drive.google.com/...

âœ… Entrega 2
ğŸ“ SOFTYS ARGENTINA - ZARATE
ğŸ“„ Remito: 37550
ğŸ”— https://drive.google.com/...
```

**Test 3 - Buscar Remito**:
Enviar: `remito 38269`
Respuesta esperada:
```
ğŸ“„ Remito 38269

ğŸ“¦ HDR: 7366289
ğŸ“ Destino: SCC POWER - SAN PEDRO
âœ… Completado

ğŸ“ Ver PDF:
https://drive.google.com/...
```

---

## ğŸ“Š Canvas Visual del Flujo (para N8N)

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              ASISTENTE WHATSAPP CROSSLOG                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[Webhook WhatsApp] â”€â”€â”
                     â”‚
                     â–¼
            [Detectar IntenciÃ³n]
                     â”‚
                     â–¼
              [Switch Router]
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚            â”‚            â”‚          â”‚
        â–¼            â–¼            â–¼          â–¼
   [Consulta     [Resumen]   [Buscar    [Ayuda]
    Estado]                   Remito]
        â”‚            â”‚            â”‚          â”‚
        â–¼            â–¼            â–¼          â”‚
  [GSheets      [GSheets]    [GSheets]      â”‚
   Lookup]                    Search]       â”‚
        â”‚            â”‚            â”‚          â”‚
        â–¼            â–¼            â–¼          â”‚
    [Code:       [Code:       [Code:        â”‚
   Generar      Generar      Generar        â”‚
   Mensaje]     Resumen]     Info]          â”‚
        â”‚            â”‚            â”‚          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
            [HTTP Request]
                     â”‚
                     â–¼
           [WhatsApp Response]
```

### Diagrama con UbicaciÃ³n en Canvas

```
PosiciÃ³n Y=0:   [Webhook WhatsApp]
                      â”‚
PosiciÃ³n Y=200: [Detectar IntenciÃ³n]
                      â”‚
PosiciÃ³n Y=400:  [Switch Router]
                      â”‚
                â”Œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
                â”‚     â”‚     â”‚     â”‚
PosiciÃ³n Y=600: â”‚     â”‚     â”‚     â””â”€[Ayuda]
          [Consulta] [Resumen] [Remito]
          X=-300     X=0      X=300   X=600
                â”‚     â”‚     â”‚
PosiciÃ³n Y=800: â”‚     â”‚     â”‚
        [GSheets] [GSheets] [GSheets]
                â”‚     â”‚     â”‚
PosiciÃ³n Y=1000:â”‚     â”‚     â”‚
          [Code] [Code] [Code]
                â”‚     â”‚     â”‚
                â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
                                  â”‚
PosiciÃ³n Y=1200:         [HTTP Request]
```

---

**Fecha**: 20/10/2025
**VersiÃ³n**: 4.0 - Destinos corregidos + Asistente WhatsApp
**Proyecto**: CROSSLOG PWA - N8N Email Notifications + WhatsApp Assistant
